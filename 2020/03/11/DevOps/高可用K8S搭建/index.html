<!DOCTYPE html>
<html>
<head>
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?493a2f87364df67d7b0018c29a2cde1a"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    
    <title>高可用K8S搭建（Ubuntu18.04） | Lockey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="K8S,Kubernetes,编排,高可用">
    <meta name="description" content="本文资料整理自网络，对其中过时部分进行修正！ 运行环境为：KVM 虚拟机（先根据下文第一部分制作基础镜像，再用基础镜像克隆为各个 master、worker 节点，可以节省时间） 适用版本为： 操作系统：Ubuntu18.04 Kubeadm：GitVersion:&amp;quot;v1.17.3&amp;quot; K8S组件版本如下： kube-apiserver:v1.17.4 kube-control">
<meta name="keywords" content="K8S,Kubernetes,编排,高可用">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用K8S搭建（Ubuntu18.04）">
<meta property="og:url" content="http:&#x2F;&#x2F;www.lockey.xyz&#x2F;2020&#x2F;03&#x2F;11&#x2F;DevOps&#x2F;%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA&#x2F;index.html">
<meta property="og:site_name" content="Lockey">
<meta property="og:description" content="本文资料整理自网络，对其中过时部分进行修正！ 运行环境为：KVM 虚拟机（先根据下文第一部分制作基础镜像，再用基础镜像克隆为各个 master、worker 节点，可以节省时间） 适用版本为： 操作系统：Ubuntu18.04 Kubeadm：GitVersion:&amp;quot;v1.17.3&amp;quot; K8S组件版本如下： kube-apiserver:v1.17.4 kube-control">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-03-18T03:44:35.704Z">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" type="application/atom+xml" title="Lockey" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    
    
    <meta name="baidu-site-verification" content="ZUtwl2HaDt" />
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off" target="">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Lockey</h5>
          <a href="mailto:196349143@qq.com" target="_blank" rel="noopener" title="196349143@qq.com" class="mail">196349143@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/Lockeysama" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">高可用K8S搭建（Ubuntu18.04）</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search" target="">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare" target="">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">高可用K8S搭建（Ubuntu18.04）</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-03-11T02:53:25.000Z" itemprop="datePublished" class="page-time">
  2020-03-11
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第一部分-基础镜像准备"><span class="post-toc-number">1.</span> <span class="post-toc-text">第一部分----基础镜像准备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#harbor-安装"><span class="post-toc-number">1.0.1.</span> <span class="post-toc-text">Harbor 安装</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#确保节点之中不可以有重复的主机名-mac-地址或-product-uuid"><span class="post-toc-number">1.0.2.</span> <span class="post-toc-text">确保节点之中不可以有重复的主机名、MAC 地址或 product_uuid</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#hostname-修改"><span class="post-toc-number">1.0.2.1.</span> <span class="post-toc-text">hostname 修改</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#查看-product-uuid"><span class="post-toc-number">1.0.2.2.</span> <span class="post-toc-text">查看 product_uuid</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#关闭防火墙-生产环境不建议关闭"><span class="post-toc-number">1.0.3.</span> <span class="post-toc-text">关闭防火墙（生产环境不建议关闭）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#关闭-swap"><span class="post-toc-number">1.0.4.</span> <span class="post-toc-text">关闭 swap</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#禁用-grub-ipv6"><span class="post-toc-number">1.0.5.</span> <span class="post-toc-text">禁用 GRUB ipv6</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设置对应时区-如上海"><span class="post-toc-number">1.0.6.</span> <span class="post-toc-text">设置对应时区（如上海）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设置-dns"><span class="post-toc-number">1.0.7.</span> <span class="post-toc-text">设置 DNS</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#升级操作系统内核"><span class="post-toc-number">1.0.8.</span> <span class="post-toc-text">升级操作系统内核</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启用-ipvs-内核模块"><span class="post-toc-number">1.0.9.</span> <span class="post-toc-text">启用 IPVS 内核模块</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#内核参数调整"><span class="post-toc-number">1.0.10.</span> <span class="post-toc-text">内核参数调整</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#确保-iptables-工具不使用-nftables-后端"><span class="post-toc-number">1.0.11.</span> <span class="post-toc-text">确保 iptables 工具不使用 nftables 后端</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#切换旧版-ubuntu"><span class="post-toc-number">1.0.11.1.</span> <span class="post-toc-text">切换旧版（Ubuntu）</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#docker-ce-安装"><span class="post-toc-number">1.0.12.</span> <span class="post-toc-text">docker-ce 安装</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#docker-compose-安装"><span class="post-toc-number">1.0.13.</span> <span class="post-toc-text">docker-compose 安装</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#kubeadm-套件安装-国内"><span class="post-toc-number">1.0.14.</span> <span class="post-toc-text">Kubeadm 套件安装（国内）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第二部分-高可用集群搭建"><span class="post-toc-number">2.</span> <span class="post-toc-text">第二部分----高可用集群搭建</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#nginx-本地代理"><span class="post-toc-number">2.0.1.</span> <span class="post-toc-text">Nginx 本地代理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#配置-master-节点-hosts"><span class="post-toc-number">2.0.1.1.</span> <span class="post-toc-text">配置 master 节点 hosts</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#编写-nginx-配置文件"><span class="post-toc-number">2.0.1.2.</span> <span class="post-toc-text">编写 Nginx 配置文件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#启动-nginx"><span class="post-toc-number">2.0.1.3.</span> <span class="post-toc-text">启动 Nginx</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#高可用外部-etcd-集群搭建"><span class="post-toc-number">2.0.2.</span> <span class="post-toc-text">高可用外部 ETCD 集群搭建</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#测试-etcd-集群"><span class="post-toc-number">2.0.2.1.</span> <span class="post-toc-text">测试 etcd 集群</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#api-server-master-高可用"><span class="post-toc-number">2.0.3.</span> <span class="post-toc-text">API-Server（Master） 高可用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#配置自定义-kubeadm-config-yaml"><span class="post-toc-number">2.0.3.1.</span> <span class="post-toc-text">配置自定义 kubeadm-config.yaml</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#初始化-master"><span class="post-toc-number">2.0.3.2.</span> <span class="post-toc-text">初始化 Master</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#master-测试"><span class="post-toc-number">2.0.3.3.</span> <span class="post-toc-text">master 测试</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#结束"><span class="post-toc-number">2.0.4.</span> <span class="post-toc-text">结束</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#甜点"><span class="post-toc-number">2.0.5.</span> <span class="post-toc-text">甜点</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-DevOps/高可用K8S搭建"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">高可用K8S搭建（Ubuntu18.04）</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-03-11 10:53:25" datetime="2020-03-11T02:53:25.000Z"  itemprop="datePublished">2020-03-11</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <div class="warning">
<p>本文资料整理自网络，对其中过时部分进行修正！<br>
运行环境为：KVM 虚拟机（先根据下文第一部分制作基础镜像，再用基础镜像克隆为各个 master、worker 节点，可以节省时间）<br>
适用版本为：<br>
操作系统：Ubuntu18.04<br>
Kubeadm：GitVersion:&quot;v1.17.3&quot;<br>
K8S组件版本如下：<br>
kube-apiserver:v1.17.4<br>
kube-controller-manager:v1.17.4<br>
kube-scheduler:v1.17.4<br>
kube-proxy:v1.17.4<br>
pause:3.1<br>
etcd:3.4.3-0<br>
coredns:1.6.5</p>
</div>
<h2 id="第一部分-基础镜像准备"><a class="header-anchor" href="#第一部分-基础镜像准备"></a>第一部分----基础镜像准备</h2>
<section class="reference"></section>
<h4 id="harbor-安装"><a class="header-anchor" href="#harbor-安装"></a>Harbor 安装</h4>
<section class="reference">
<p>详见</p>
</section>
<h4 id="确保节点之中不可以有重复的主机名-mac-地址或-product-uuid"><a class="header-anchor" href="#确保节点之中不可以有重复的主机名-mac-地址或-product-uuid"></a>确保节点之中不可以有重复的主机名、MAC 地址或 product_uuid</h4>
<section class="reference"></section>
<h5 id="hostname-修改"><a class="header-anchor" href="#hostname-修改"></a>hostname 修改</h5>
<section class="reference">
<ul>
<li>Ubuntu：<code>hostnamectl set-hostname xxx</code></li>
</ul>
</section>
<h5 id="查看-product-uuid"><a class="header-anchor" href="#查看-product-uuid"></a>查看 product_uuid</h5>
<section class="reference">
<p><code>sudo cat /sys/class/dmi/id/product_uuid</code></p>
</section>
<h4 id="关闭防火墙-生产环境不建议关闭"><a class="header-anchor" href="#关闭防火墙-生产环境不建议关闭"></a>关闭防火墙（生产环境不建议关闭）</h4>
<section class="sample">
<pre><code>systemctl stop ufw
systemctl disable ufw
</code></pre>
</section>
<section class="reference">
<div class="warning">
<p>生产环境，建议启用防火墙，并开启 etcd、apiserver等多个端口</p>
</div>
</section>
<h4 id="关闭-swap"><a class="header-anchor" href="#关闭-swap"></a>关闭 swap</h4>
<section class="reference">
<p>查看 swap：$<code>cat /proc/swaps</code><br>
注释 swap 设置：$<code>vim /etc/fstab</code><br>
关闭 swap：$<code>swapoff -a</code></p>
</section>
<h4 id="禁用-grub-ipv6"><a class="header-anchor" href="#禁用-grub-ipv6"></a>禁用 GRUB ipv6</h4>
<section class="sample">
<p>编辑：$<code>vim /etc/default/grub</code><br>
修改：</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;&quot;
GRUB_CMDLINE_LINUX=&quot;&quot;
</code></pre>
</section>
<section class="reference">
<p>↓</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;ipv6.disable=1&quot;
GRUB_CMDLINE_LINUX=&quot;ipv6.disable=1&quot;
</code></pre>
<p>更新：$<code>update-grub</code></p>
</section>
<h4 id="设置对应时区-如上海"><a class="header-anchor" href="#设置对应时区-如上海"></a>设置对应时区（如上海）</h4>
<section class="reference">
<p>执行：$<code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code></p>
</section>
<h4 id="设置-dns"><a class="header-anchor" href="#设置-dns"></a>设置 DNS</h4>
<section class="sample">
<p>编辑：$<code>vim /etc/systemd/resolved.conf</code><br>
修改：</p>
<pre><code># 地址来自阿里 DNS
DNS=223.5.5.5 223.6.6.6 
</code></pre>
</section>
<section class="reference"></section>
<h4 id="升级操作系统内核"><a class="header-anchor" href="#升级操作系统内核"></a>升级操作系统内核</h4>
<section class="reference">
<p>参考自<a href="https://qingmu.io/2019/05/17/Deploy-a-highly-available-cluster-with-kubeadm/#%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8" target="_blank" rel="noopener">青木のJava小屋</a></p>
<p>查看本机内核：$<code>uname -a</code></p>
<div class="info">
<p>可以根据实际情况<a href="https://kernel.ubuntu.com/~kernel-ppa/mainline/" target="_blank" rel="noopener">选择版本</a></p>
</div>
<p>执行：$<code>dpkg -i xxx.deb</code>升级内核（可使用通配符）</p>
<p>清理旧内核：$<code>dpkg --list | grep linux | awk '{print $2}' | grep 旧内核版本 | xargs apt purge -y</code></p>
<div class="warning">
<p>内核操作风险较大，请一步步确认没问题再执行！</p>
</div>
</section>
<h4 id="启用-ipvs-内核模块"><a class="header-anchor" href="#启用-ipvs-内核模块"></a>启用 IPVS 内核模块</h4>
<section class="sample">
<p>执行：</p>
<pre><code>echo &gt; /etc/modules-load.d/ipvs.conf
module=(ip_vs
        ip_vs_rr
        ip_vs_wrr
        ip_vs_sh
        ip_vs_lc
        br_netfilter
        nf_conntrack)
for kernel_module in ${module[@]};do
    /sbin/modinfo -F filename $kernel_module |&amp; grep -qv ERROR &amp;&amp; echo $kernel_module &gt;&gt; /etc/modules-load.d/ipvs.conf || :
done
</code></pre>
</section>
<section class="reference">
<p>查看：$<code>lsmod | grep ip_vs</code><br>
输出如下信息为成功 ↓</p>
<pre><code>ip_vs_sh               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 147456  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          143360  6 xt_conntrack,nf_nat,ipt_MASQUERADE,nf_nat_ipv4,nf_conntrack_netlink,ip_vs
libcrc32c              16384  5 nf_conntrack,nf_nat,btrfs,raid456,ip_vs
</code></pre>
</section>
<h4 id="内核参数调整"><a class="header-anchor" href="#内核参数调整"></a>内核参数调整</h4>
<section class="sample">
<pre><code>cat &gt; /etc/sysctl.conf &lt;&lt; EOF
# https://github.com/moby/moby/issues/31208 
# ipvsadm -l --timout
# 修复ipvs模式下长连接timeout问题 小于900即可
net.ipv4.tcp_keepalive_time = 800
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10

net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv4.neigh.default.gc_stale_time = 120
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_announce = 2
net.ipv4.ip_forward = 1
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.bridge.bridge-nf-call-arptables = 1
vm.swappiness = 0
vm.max_map_count=262144
EOF
</code></pre>
</section>
<section class="reference"></section>
<h4 id="确保-iptables-工具不使用-nftables-后端"><a class="header-anchor" href="#确保-iptables-工具不使用-nftables-后端"></a>确保 iptables 工具不使用 nftables 后端</h4>
<section class="reference"></section>
<h5 id="切换旧版-ubuntu"><a class="header-anchor" href="#切换旧版-ubuntu"></a>切换旧版（Ubuntu）</h5>
<section class="sample">
<pre><code>update-alternatives --set iptables /usr/sbin/iptables-legacy
update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
update-alternatives --set arptables /usr/sbin/arptables-legacy
update-alternatives --set ebtables /usr/sbin/ebtables-legacy
</code></pre>
</section>
<section class="reference"></section>
<h4 id="docker-ce-安装"><a class="header-anchor" href="#docker-ce-安装"></a>docker-ce 安装</h4>
<section class="reference">
<p>安装依赖系统工具：$<code>apt install -y apt-transport-https ca-certificates curl software-properties-common</code><br>
安装GPG证书：$<code>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</code><br>
写入源：$<code>add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</code><br>
执行：$<code>apt update</code><br>
安装 docker-ce：$<code>apt install -y docker-ce</code>（另可指定版本号安装指定版本）<br>
设置镜像加速，可以选择阿里云镜像加速服务，详见阿里云镜像加速页面文档</p>
</section>
<h4 id="docker-compose-安装"><a class="header-anchor" href="#docker-compose-安装"></a>docker-compose 安装</h4>
<section class="sample">
<p>执行：</p>
<pre><code>curl -L https://github.com/docker/compose/releases/download/1.25.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre>
</section>
<section class="reference"></section>
<h4 id="kubeadm-套件安装-国内"><a class="header-anchor" href="#kubeadm-套件安装-国内"></a>Kubeadm 套件安装（国内）</h4>
<section class="reference">
<p>新增源文件：$<code>vim /etc/apt/sources.list.d/kubernetes.list</code><br>
写入源：$<code>deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</code><br>
执行：$<code>apt update</code> 得到错误信息的 key 的末尾8位<br>
执行：$<code>gpg --keyserver keyserver.ubuntu.com --recv-keys 【8位key】</code><br>
执行：$<code>gpg --export --armor 【8位key】 | sudo apt-key add -</code><br>
再次执行：$<code>apt update</code><br>
安装 Kubeadm 套件：$<code>apt install -y kubelet kubeadm kubectl</code></p>
</section>
<h2 id="第二部分-高可用集群搭建"><a class="header-anchor" href="#第二部分-高可用集群搭建"></a>第二部分----高可用集群搭建</h2>
<section class="reference">
<div class="info">
<p>本文高可用模式为：ETCD 高可用 + API-Server 高可用<br>
ETCD：由于 ETCD 使用 Raft 算法，所以节点一般为奇数个，本文使用3个节点<br>
API-Server：本文使用3个节点</p>
</div>
</section>
<h4 id="nginx-本地代理"><a class="header-anchor" href="#nginx-本地代理"></a>Nginx 本地代理</h4>
<section class="reference">
<p>用于访问 master 节点，并在其中某些 master 节点不可用时，自动访问可用节点。<br>
可以部署在每一台 K8S 节点上部署，也可另外部署外部 Nginx 负载均衡节点，本文在每台 K8S 节点上均有部署</p>
</section>
<h5 id="配置-master-节点-hosts"><a class="header-anchor" href="#配置-master-节点-hosts"></a>配置 master 节点 hosts</h5>
<section class="sample">
<pre><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF
127.0.0.1 server.k8s.local
10.0.0.65 server1.k8s.local
10.0.0.66 server2.k8s.local
10.0.0.67 server3.k8s.local
EOF
</code></pre>
</section>
<section class="reference">
<div class="warning">
<p>IP 请跟请根据实际情况替换</p>
</div>
</section>
<h5 id="编写-nginx-配置文件"><a class="header-anchor" href="#编写-nginx-配置文件"></a>编写 Nginx 配置文件</h5>
<section class="sample">
<pre><code>mkdir -p /etc/nginx
cat &gt; /etc/nginx/nginx.conf &lt;&lt; EOF
worker_processes auto;
user root;
events {
    worker_connections  20240;
    use epoll;
}
error_log /var/log/nginx_error.log info;

stream {
    upstream kube-servers {
        hash $remote_addr consistent;
        server server1.k8s.local:6443 weight=5 max_fails=1 fail_timeout=3s;
        server server2.k8s.local:6443 weight=5 max_fails=1 fail_timeout=3s;
        server server3.k8s.local:6443 weight=5 max_fails=1 fail_timeout=3s;
    }

    server {
        listen 8443 reuseport;
        proxy_connect_timeout 3s;
        # 加大timeout
        proxy_timeout 3000s;
        proxy_pass kube-servers;
    }
}
EOF
</code></pre>
</section>
<section class="reference"></section>
<h5 id="启动-nginx"><a class="header-anchor" href="#启动-nginx"></a>启动 Nginx</h5>
<section class="sample">
<pre><code>docker run --restart=always \
-v /etc/apt/sources.list:/etc/apt/sources.list \
-v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf \
--name kps \
--net host \
-it \
-d \
nginx
</code></pre>
</section>
<section class="reference"></section>
<h4 id="高可用外部-etcd-集群搭建"><a class="header-anchor" href="#高可用外部-etcd-集群搭建"></a>高可用外部 ETCD 集群搭建</h4>
<section class="sample">
<div class="info">
<p>由于 etcd 不需要对外开放，所以本文不使用 tls</p>
</div>
<div class="warning">
<p>启动参数<a href="https://qingmu.io/2019/05/17/Deploy-a-highly-available-cluster-with-kubeadm/#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" target="_blank" rel="noopener">注意事项</a>：<br>
–auto-compaction-retention<br>
由于ETCD数据存储多版本数据，随着写入的主键增加历史版本需要定时清理，默认的历史数据是不会清理的，数据达到2G就不能写入，必须要清理压缩历史数据才能继续写入;所以根据业务需求，在上生产环境之前就提前确定，历史数据多长时间压缩一次;推荐一小时压缩一次数据这样可以极大的保证集群稳定，减少内存和磁盘占用</p>
<p>–max-request-bytes<br>
etcd Raft消息最大字节数，ETCD默认该值为1.5M; 但是很多业务场景发现同步数据的时候1.5M完全没法满足要求，所以提前确定初始值很重要;由于1.5M导致我们线上的业务无法写入元数据的问题，我们紧急升级之后把该值修改为默认32M，但是官方推荐的是10M，大家可以根据业务情况自己调整</p>
<p>–quota-backend-bytes<br>
ETCD db数据大小，默认是2G，当数据达到2G的时候就不允许写入，必须对历史数据进行压缩才能继续写入;参加1里面说的，我们启动的时候就应该提前确定大小，官方推荐是8G，这里我们也使用8G的配置</p>
</div>
<p>在 etcd 集群个节点主机上运行如下命令（注意修改中括号内对应的信息）：</p>
<pre><code>mkdir -p /var/etcd
docker rm [name] -f
rm -rf /var/etcd/*
docker run --restart=always --net host -it --name [name] -d \
-v /var/etcd:/var/etcd \
-v /etc/localtime:/etc/localtime \
[仓库名]/etcd:[版本号] \
etcd --name [etcd name] \
--auto-compaction-retention &quot;1h&quot; --max-request-bytes &quot;33554432&quot; --quota-backend-bytes &quot;8589934592&quot; \
--data-dir=/var/etcd/etcd-data \
--listen-client-urls http://0.0.0.0:2379 \
--listen-peer-urls http://0.0.0.0:2380 \
--initial-advertise-peer-urls http://[本节点域名或IP]:2380 \
--advertise-client-urls http://[本节点域名或IP]:2379,http://[本节点域名或IP]:2380 \
-initial-cluster-token etcd-cluster \
-initial-cluster &quot;[本机 etcd name]=http://[本节点域名或IP]:2380,[其他etcd name1]=http://[其他节点域名或IP]:2380,[其他etcd name2]=http://[其他节点域名或IP]:2380&quot; \
-initial-cluster-state new
</code></pre>
</section>
<section class="reference"></section>
<h5 id="测试-etcd-集群"><a class="header-anchor" href="#测试-etcd-集群"></a>测试 etcd 集群</h5>
<section class="sample">
<p>进入正在运行的 etcd 容器：$<code>docker exec -it [name] sh</code><br>
查看集群状态：$<code>etcdctl --write-out=table --endpoints=&quot;http://[节点域名或IP]:2379,http://[节点域名或IP]:2379,http://[节点域名或IP]:2379&quot; endpoint status</code><br>
查看集群健康：$<code>etcdctl --write-out=table --endpoints=&quot;http://[节点域名或IP]:2379,http://[节点域名或IP]:2379,http://[节点域名或IP]:2379&quot; endpoint health</code></p>
<p>测试集群可用性：</p>
<pre><code># 任意节点存入数据
etcdctl put /test/key &quot;123&quot;
# 任意节点取出数据，取出正常，集群可用
etcdctl get /test/key
</code></pre>
</section>
<section class="reference"></section>
<h4 id="api-server-master-高可用"><a class="header-anchor" href="#api-server-master-高可用"></a>API-Server（Master） 高可用</h4>
<section class="reference"></section>
<h5 id="配置自定义-kubeadm-config-yaml"><a class="header-anchor" href="#配置自定义-kubeadm-config-yaml"></a>配置自定义 kubeadm-config.yaml</h5>
<section class="sample">
<div class="warning">
<p>注意修改对应的版本号，仓库路径等</p>
</div>
<pre><code>apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
kubernetesVersion: v1.17.0
imageRepository: [仓库路径]
apiServer:
  extraArgs:
    storage-backend: etcd3
  extraVolumes:
    - hostPath: /etc/localtime
      mountPath: /etc/localtime
      name: localtime
  certSANs:
    - &quot;prod-server.k8s.local&quot;
    - &quot;server1.k8s.local&quot;
    - &quot;server2.k8s.local&quot;
    - &quot;server3.k8s.local&quot;
    - &quot;127.0.0.1&quot;
    - &quot;10.0.0.65&quot;
    - &quot;10.0.0.66&quot;
    - &quot;10.0.0.67&quot;
    - &quot;kubernetes&quot;
    - &quot;kubernetes.default&quot;
    - &quot;kubernetes.default.svc&quot;
    - &quot;kubernetes.default.svc.cluster&quot;
    - &quot;kubernetes.default.svc.cluster.local&quot;
controllerManager:
  extraArgs:
    experimental-cluster-signing-duration: 867000h
  extraVolumes:
    - hostPath: /etc/localtime
      mountPath: /etc/localtime
      name: localtime
scheduler:
  extraVolumes:
    - hostPath: /etc/localtime
      mountPath: /etc/localtime
      name: localtime
networking:
  # pod 网段
  podSubnet: 172.224.0.0/12
  # SVC 网络
  serviceSubnet: 10.96.0.0/12
controlPlaneEndpoint: server.k8s.local:8443
etcd:
  external:
    endpoints:
      - http://server1.k8s.local:2379
      - http://server2.k8s.local:2379
      - http://server3.k8s.local:2379
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs
ipvs:
  scheduler: lc
  minSyncPeriod: 5s
  syncPeriod: 15s
</code></pre>
</section>
<section class="reference"></section>
<h5 id="初始化-master"><a class="header-anchor" href="#初始化-master"></a>初始化 Master</h5>
<section class="reference">
<p>执行：$<code>kubeadm init --config=kubeadm-config.yaml --upload-certs</code></p>
<div class="info">
<p>–config=kubeadm-config.yaml 为上一步骤编写的文件<br>
–upload-certs 参数将证书上传到 etcd 中，后续不需要手动分发</p>
</div>
<p>初始化结束，控制台输出：<br>
Your Kubernetes control-plane has initialized successfully!</p>
<p>To start using your cluster, you need to run the following as a regular user:<br>
<strong><em>复制并执行下列命令：可以以普通用户操作集群</em></strong><br>
<font color=red>mkdir -p $HOME/.kube<br>
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>
sudo chown $(id -u):$(id -g) $HOME/.kube/config</font></p>
<p>You should now deploy a pod network to the cluster.<br>
Run “kubectl apply -f [podnetwork].yaml” with one of the options listed at:<br>
<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<p>You can now join any number of the control-plane node running the following command on each as root:<br>
<strong><em>复制并执行下列命令：其余 master 可以加入到到该集群</em></strong><br>
<font color=green>kubeadm join server.k8s.local:8443 --token uue99t.w9cenfznjoo2e1u6 <br>
–discovery-token-ca-cert-hash sha256:afd406ce180ce4c9271c0e7b4c3381df72cd75e766f934fd439d101ae1022a43 <br>
–control-plane --certificate-key 1621bb7101d2fa4050779aaa753e89d49ee7db57129b6b4986c82b45fb4dcbe5</font    ></p>
<p>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!<br>
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use<br>
&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</p>
<p>Then you can join any number of worker nodes by running the following on each as root:<br>
<strong><em>复制并执行下列命令：worker 可以加入到到该集群</em></strong><br>
<font color=blue>kubeadm join server.k8s.local:8443 --token uue99t.w9cenfznjoo2e1u6 <br>
–discovery-token-ca-cert-hash sha256:afd406ce180ce4c9271c0e7b4c3381df72cd75e766f934fd439d101ae1022a43<font></p>
<div class="warning">
<p>以上命令中出现的 hash、key 需要跟使用者安装后出现的一致，不可直接复制使用！<br>
Token 失效可以使用命令重新生成 ↓<br>
创建一个新的token：<br>
kubeadm token create<br>
查看token列表：<br>
kubeadm token list<br>
获取ca证书sha256编码hash值：<br>
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'<br>
最终生成的cmd：<br>
kubeadm join server.k8s.local:8443 --token ${TOKEN} --discovery-token-ca-cert-hash sha256:${CaSHA256}</p>
</div>
</section>
<h5 id="master-测试"><a class="header-anchor" href="#master-测试"></a>master 测试</h5>
<section class="reference">
<p>执行：$<code>kubectl get node</code> 可以查看集群是否加入成功（可以显示加入集群内的所有节点）<br>
执行：$<code>kubectl get pod -A</code> 可以查看所有集群内正在运行的pod（检查 apiserver、controller-manager、proxy、scheduler 是否是 running 状态，coredns 目前为 pending 状态）</p>
</section>
<h4 id="结束"><a class="header-anchor" href="#结束"></a>结束</h4>
<section class="reference">
<p>至此，高可用 K8S 安装成功。</p>
</section>
<h4 id="甜点"><a class="header-anchor" href="#甜点"></a>甜点</h4>
<section class="reference">
<p>集群重置：$<code>kubeadm reset</code></p>
<div class="info">
<p>如果是外接 ETCD ，需要清空外接 ETCD 数据：$<code>etcdctl del &quot;&quot; --prefix</code></p>
</div>
<p><strong><em>参考链接</em></strong><br>
<a href="https://qingmu.io/2019/05/17/Deploy-a-highly-available-cluster-with-kubeadm/" target="_blank" rel="noopener">在阿里云的VPC部署高可用kubernetes</a></p>
</section>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-03-18T03:44:35.704Z" itemprop="dateUpdated">2020-03-18 11:44:35</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://www.lockey.xyz">
            <img src="/img/avatar.jpg" alt="Lockey">
            Lockey
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light" target="">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S/" rel="tag">K8S</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E6%8E%92/" rel="tag">编排</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" rel="tag">高可用</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&title=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&pic=http://www.lockey.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" target="_blank" rel="noopener" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&title=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&via=http://www.lockey.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" target="" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/03/12/Linux/Linux%E5%9F%BA%E7%A1%80%E9%9A%8F%E7%AC%94/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Linux 基础随笔</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/12/31/DevOps/K8S/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">K8S</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: 'd3fa7d2ac1b4bf641e09',
          clientSecret: '9b3c0342a36274f142db4652376ea42260ed4766',
          repo: 'lockey.github.io',
          owner: 'Lockeysama',
          admin: ['Lockeysama'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;" target=""><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Lockey &copy; 2019 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" target="" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&title=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&pic=http://www.lockey.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" target="_blank" rel="noopener" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&title=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《高可用K8S搭建（Ubuntu18.04）》 — Lockey&url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/&via=http://www.lockey.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.lockey.xyz/2020/03/11/DevOps/%E9%AB%98%E5%8F%AF%E7%94%A8K8S%E6%90%AD%E5%BB%BA/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" target="_blank" rel="noopener"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADJ0lEQVR42u3aQXIiQQwEQP//0+wDMEOVhDegyTk5MExPNodCUv/8xNft7rr/7/07H90nX/H69eu1XnBhY2Njfwj7dnldvye5z/UjXt8zoSbP+cudsbGxsY9jJ4slWZDfM79DsqH1utjY2NjYo+hKgu36s9fPho2NjY2dsNsWUnufopzAxsbGxi6bSputeXSf2Yr/tZeGjY2N/fbsduz6zn//yXwbGxsb+43Zt/KafSoPsLZcGSqwsbGxD2LnAZAcuGkPX7YHetqh8pPnx8bGxj6C3QbMXwwJZgPjTcmEjY2N/W3sJMaS5TflShulT+6MjY2NfRw7+dG/H8TODgDtpx8Pe2nY2NjYR7DzkMibPrNgaxtP7QZhY2Njn83OW0JJGORFSNu0ul6rjUNsbGzsM9g5KR8PtIVHEnWzsmR4UgkbGxv7o9j5j/i80b/flFnrf5jb2NjY2EewZxGyGei2JU17DGg2SMDGxsb+XHZeEiTDgH0gbUa/xQADGxsb+yD2rNU+GyTkr+dHgvLCI/rOsbGxsT+Q3QZG+1j74qTd7uhpsbGxsQ9l568nkbY5cJlv3LDNhI2NjX0Eez+gzbemZcy2OPrysLGxsQ9i5wu0+E2h0sbnrI2FjY2NfQY7b9bMSpd2m/ZFSBTA2NjY2Mex97GRD4OvG0mzY6BtBGJjY2Ofyk4+PGskFQ+0aCQlsfpLgGFjY2Mfwc4b+jm+ZSQtrX15g42Njf0N7HZY2wbbpiyZDYOxsbGxz2bnkZA/+uadbasoL3WwsbGxv42dREu7ZDsk3pyTrM8oYWNjYx/EflXBsAmY2VUfKsLGxsY+jj0rS9rYyzd0WGDEZ3KwsbGxz2MnwZCHxKa0yIe4s63ExsbGPok9+7nftnVmLaTZRkcbhI2NjX0Qu10yLz/aKNpH5mY4gY2Njf3p7Dy0ZuXEplDJ10oCDBsbG/ts9uywzmzAsC9g2qYVNjY2NnZSJLQlyr5JlP/9ZL6NjY2N/WXsvA3UlhAbat0Ow8bGxj6O3Q5323Z/e+ekqMg/u+qlYWNjY789e3ZcJl/sVUOFfHh8/XViY2NjH8T+B2gX7pqPsVgdAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1278306875&web_id=1278306875')

</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '(～﹃～)~zZ';
            clearTimeout(titleTime);
        } else {
            document.title = '_(:з」∠)_';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
